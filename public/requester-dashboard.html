<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requester Dashboard</title>
    <link rel="stylesheet" href="style.css"> <!-- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
</head>

<body>
    <div class="dashboard-container">
        <h1 class="dashboard-title">Welcome, Requester!</h1>

        <!-- Submit Document Section -->
        <h2>Submit Your Document</h2>
        <form id="uploadDocumentForm" class="form-group">
            <input type="text" id="title" placeholder="Enter document title" required>
            <input type="hidden" id="requester_id" value="1"> <!-- ID ‡∏Ç‡∏≠‡∏á requester -->
            <input type="text" id="description" placeholder="Enter description" required>
            <input type="file" id="documentFile" required>
            <button type="submit">Submit Document</button>
        </form>



        <!-- Document Status Section -->
        <h2>Track Document Status</h2>
        <div id="documentStatus" class="status">
            Document Status: <span id="statusText" class="pending">Pending</span>
        </div>
    </div>

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Approver -->
    <label for="approver_id">Send to Approver:</label>
    <select id="approver_id" name="approverId" required>
        <option value="">-- Select Approver --</option>
    </select>

    <h2>Your Submitted Documents</h2>
    <div id="myDocuments"></div>


    </div>


    <script>
        document.getElementById('uploadDocumentForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const file = document.getElementById('documentFile').files[0];
            const title = document.getElementById('title').value;
            const requesterId = document.getElementById('requester_id').value;
            const approverId = document.getElementById('approver_id').value;
            const description = document.getElementById('description').value;


            const formData = new FormData();
            formData.append('file', file); // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö upload.single('file')
            formData.append('title', title);
            formData.append('requesterId', requesterId);
            formData.append('approverId', approverId);
            formData.append('description', description);

            try {
                const response = await fetch('http://localhost:8000/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    console.log(`‚úÖ Upload success: "${file.name}"`);
                    console.log('üí¨ Message:', result.message);
                    alert('Upload success');
                } else {
                    alert('Upload error: ' + result.error);
                }
            } catch (error) {
                console.error('Upload failed:', error);
                alert('Upload failed: ' + error.message);
            }
        });


        async function trackDocumentStatus(documentId) {
            try {
                // Fetch document status from the server
                const response = await fetch(`http://localhost:8000/api/document-status/${documentId}`);
                const result = await response.json();

                if (response.ok) {
                    // Update UI with the document status
                    const status = result.status; // This should be "approved", "rejected", or "pending"
                    const statusTextElement = document.getElementById('statusText');
                    statusTextElement.textContent = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize the first letter

                    // Change status text color based on status
                    statusTextElement.className = status;
                } else {
                    alert('Error fetching document status: ' + result.error);
                }
            } catch (error) {
                console.error('Error fetching document status:', error);
                alert('Error fetching document status: ' + error.message);
            }
        }

        async function loadMyDocuments() {
            const requesterId = localStorage.getItem('userId');
            const container = document.getElementById('myDocuments');
            container.innerHTML = '';

            try {
                const res = await fetch(`http://localhost:8000/api/requester-documents/${requesterId}`);
                const result = await res.json();

                if (result.success && Array.isArray(result.documents)) {
                    result.documents.forEach(doc => {
                        const div = document.createElement('div');
                        div.className = 'status';

                        div.innerHTML = `
                    <p><strong>${doc.title}</strong></p>
                    <p>To Approver: ${doc.approver}</p>
                    <p>Status: <span class="${doc.status}">${doc.status.charAt(0).toUpperCase() + doc.status.slice(1)}</span></p>
                    <p><a href="${doc.file_path}" target="_blank">View File</a></p>
                    <hr/>
                `;

                        container.appendChild(div);
                    });
                } else {
                    container.textContent = 'No documents submitted.';
                }
            } catch (err) {
                console.error('Error loading documents:', err);
                container.textContent = 'Failed to load documents.';
            }
        }

        // ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('DOMContentLoaded', () => {
            loadApprovers(); // ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            loadMyDocuments(); // ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        });


        /*async function loadApprovers() {
    try {
        const res = await fetch('http://localhost:8000/api/approvers');
        const data = await res.json();

        if (!Array.isArray(data)) {
            console.error('Expected array but got:', data);
            alert('Failed to load approvers.');
            return;
        }

        const select = document.getElementById('approver_id');
        data.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.username;
            select.appendChild(option);
        });
    } catch (err) {
        console.error('‚ùå Error loading approvers:', err);
        alert('Error fetching approvers.');
    }
}*/
        /*async function loadApprovers() {
              try {
                  const res = await fetch('http://localhost:8000/api/approvers');
                  const data = await res.json();
        
                  const approverSelect = document.getElementById('approver_id');
                  approverSelect.innerHTML = '<option value="">-- Select Approver --</option>';
        
                  data.forEach(user => {
                      const option = document.createElement('option');
                      option.value = user.id;
                      option.textContent = user.username;
                      approverSelect.appendChild(option);
                  });
              } catch (error) {
                  console.error('Failed to load approvers:', error);
                  alert('Failed to load approvers.');
              }
          }
        
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
          window.onload = () => {
              loadApprovers();
          };*/

        async function loadApprovers() {
            try {
                const res = await fetch('http://localhost:8000/api/approvers');
                const data = await res.json();

                console.log("Approvers:", data); // DEBUG

                const select = document.getElementById('approver_id');
                select.innerHTML = '<option value="">-- Select Approver --</option>';

                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load approvers:', error);
                alert('Failed to load approvers.');
            }
        }

        // ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('DOMContentLoaded', loadApprovers);
    </script>
</body>

</html>