<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Approver Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <video autoplay muted loop id="bg-video">
        <source src="7623013d2413b90d26bdfd90b5c485c3.mp4" type="video/mp4" />
      </video>
      
      <div class="top-bar">
        <div class="profile-dropdown">
          <img src="pf.jpg" class="profile-pic" onclick="toggleDropdown()" />
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="#" onclick="logout()">Logout</a>
          </div>
        </div>
      </div>
      
    <div class="main-layout">
        <div class="left-section">
          <h1 class="dashboard-title">Welcome, Approver! üìù</h1>
          <div id="pendingDocs"></div>
        </div>
      
        <div class="right-section">
          <h2 class="sub-title">üìÇ History</h2>
          <input type="text" id="searchInput" placeholder="üîç Search by Title..." oninput="filterHistory()" class="search-box">
          <div id="historyDocs" class="accordion-container"></div>
        </div>
      </div>
  <script>
    
    const approverId = localStorage.getItem('userId');// ‡∏î‡∏∂‡∏á userId ‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ login
if (!approverId) {// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ userId
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login...");
    window.location.href = 'index.html'; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
} else {
    loadPendingDocs();// ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    loadHistoryDocs();// ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
}


async function loadPendingDocs() {
    try {
        const res = await fetch(`http://localhost:8000/api/pending-docs?approverId=${approverId}`); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ pending
        const docs = await res.json();

        const container = document.getElementById('pendingDocs');// ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á container
        container.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏•‡∏¢
        if (!Array.isArray(docs) || docs.length === 0) {
            container.innerHTML = '<p style="color: gray; font-style: italic;">There are no documents pending approval.</p>';
            return;
        }

        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        docs.forEach(doc => {// ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            const div = document.createElement('div');
            div.classList.add('status');
            div.innerHTML = `
  <p><strong>${doc.title}</strong></p>
  <p><strong>From : </strong>${doc.requester}</p>
  <p><strong>Description : </strong>${doc.description}</p>
  <p><strong><a href="${doc.file_path}" target="_blank">Download File</a></strong></p>

  <textarea placeholder="Write comment here..." id="reason-${doc.document_id}" class="reject-reason-box"></textarea>

  <div class="action-buttons">
    <button class="approve-btn" onclick="updateStatus(${doc.document_id}, 'approved')"><strong>Approve</strong></button>
    <button class="reject-btn" onclick="updateStatus(${doc.document_id}, 'rejected')"><strong>Reject</strong></button>
  </div>
`;
            container.appendChild(div);// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ container
        });
    } catch (err) {
        console.error('Error loading pending documents:', err);
        document.getElementById('pendingDocs').innerHTML = '<p style="color: red;">Document loading failed</p>'; // ‡πÅ‡∏™‡∏î‡∏á error message
    }
}

//‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
async function updateStatus(docId, status) {
const reasonInput = document.getElementById(`reason-${docId}`);
  const reason = reasonInput ? reasonInput.value.trim() : '';

    const res = await fetch('http://localhost:8000/api/update-status', {// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        method: 'POST',// ‡πÉ‡∏ä‡πâ POST
        headers: { 'Content-Type': 'application/json' },// ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        body: JSON.stringify({ documentId: docId, status,reason })// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• documentId ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    });

    const result = await res.json(); // ‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    if (result.success) { //‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        alert(`Document ${status}!`);
        loadPendingDocs();
        loadHistoryDocs();
    } else {
        alert('Error: ' + result.error);
    }
}

//‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
async function loadHistoryDocs() {
    try {
        const res = await fetch(`http://localhost:8000/api/history-docs/${approverId}`);// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        const result = await res.json(); // ‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

        const container = document.getElementById('historyDocs');// ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á container
        container.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤


        if (!result.success || result.documents.length === 0) {// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            container.innerHTML = '<p style="color: gray;  font-style: italic;">No history of document approval or rejection.</p>';
            return;
        }

        result.documents.forEach(doc => {// ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    const div = document.createElement('div');
    div.classList.add('status-box');

    const statusClass = doc.status === 'approved' ? 'approved' :
                        doc.status === 'rejected' ? 'rejected' : 'pending';// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î class ‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

    const formattedDate = new Date(doc.created_at).toLocaleString(); //  format ‡πÄ‡∏ß‡∏•‡∏≤

     div.innerHTML = `
        <div class="status-header ${statusClass}">
            <span class="doc-title">${doc.title}</span>
            <span class="doc-status">${doc.status.toUpperCase()}</span>
        </div>
        <div class="status-details">
            <p><strong>From : </strong>${doc.requester}</p>
            <p><strong>Description : </strong>${doc.description}</p>
            <p><strong>Submitted At : </strong>${formattedDate}</p>
            <p><strong>Status : </strong><span class="${statusClass}">${doc.status}</span></p>
            <p><strong>Comment : </strong>${doc.reason || '-'}</p> 
            <p><strong>üìé <a href="${doc.file_path}" target="_blank">View File</a></strong></p>
        </div>
    `;

    // ‡∏õ‡∏∏‡πà‡∏° Delete ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
div.innerHTML += `
  <button class="reject-btn" onclick="deleteDocument(${doc.document_id})"><strong>üóëÔ∏è Delete</strong></button>
`;
    container.appendChild(div);// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô container
});

    } catch (error) {
        console.error('Error loading history documents:', error);
        document.getElementById('historyDocs').innerHTML = '<p style="color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';
    }
}

function toggleDropdown() {
    const menu = document.getElementById("dropdownMenu");
    menu.style.display = menu.style.display === "flex" ? "none" : "flex";
  }

  function logout() {
    localStorage.clear();// ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô localStorage (‡πÄ‡∏ä‡πà‡∏ô userId, role)
    alert("Logged out!");
    window.location.href = "index.html"; // ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ login
  }

  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å dropdown ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î
  window.addEventListener('click', function(e) {
    if (!e.target.closest('.profile-dropdown')) {
      document.getElementById("dropdownMenu").style.display = "none";
    }
  });

  function filterHistory() {
  const input = document.getElementById('searchInput').value.toLowerCase();// ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const boxes = document.querySelectorAll('#historyDocs .status-box');// ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î


  boxes.forEach(box => {
    const title = box.querySelector('.doc-title').textContent.toLowerCase();
    if (title.includes(input)) {
      box.style.display = 'block';// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠
    } else {
      box.style.display = 'none';// ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
    }
  });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
async function deleteDocument(docId) {
  if (confirm('Are you sure you want to delete this document?')) {
    try {
      const res = await fetch(`http://localhost:8000/api/documents/${docId}`, {
        method: 'DELETE'
      });
      const result = await res.json();
      if (result.success) {
        alert('Document deleted!');
        loadHistoryDocs(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
      } else {
        alert('Delete failed');
      }
    } catch (err) {
      alert('Error deleting: ' + err.message);
    }
  }
}

  </script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
</body>
</html>
